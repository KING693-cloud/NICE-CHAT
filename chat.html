<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NICE Chat</title>

<!-- PWA Manifest -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#34B7F1">
<link rel="icon" href="images(1).jpeg" type="image/jpeg">

<style>
body, html { margin:0; padding:0; font-family:Arial,sans-serif; height:100%; background:#ECE5DD; display:flex; flex-direction:column;}
header { background:#075E54; color:white; padding:10px; display:flex; align-items:center; gap:10px; }
header button { background:none; border:none; color:white; font-size:22px; cursor:pointer; }
header h3 { display:flex; align-items:center; gap:10px; margin:0;}
header img { width:35px; height:35px; border-radius:50%; object-fit:cover; border:2px solid #25D366;}
.chat-box { flex:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column; background:#ECE5DD;}
.message { max-width:75%; padding:10px; margin:8px 0; border-radius:10px; word-wrap:break-word; display:flex; flex-direction:column; white-space:pre-wrap; position:relative;}
.message.self { background:#DCF8C6; align-self:flex-end;}
.message.other { background:#fff; align-self:flex-start;}
.message .time { font-size:10px; color:#666; text-align:right; margin-top:2px;}
.message img.profile { width:25px; height:25px; border-radius:50%; border:1px solid #ccc; margin-bottom:4px;}
.message .delete-btn { margin-top:6px; font-weight:bold; font-size:13px; cursor:pointer; padding:4px 8px; border-radius:6px; text-align:center; width:fit-content;}
.message .delete-everyone { background:#d9534f; color:white; border:none;}
.message .delete-me { background:#999; color:white; border:none;}
footer { background:#fff; display:flex; align-items:center; padding:10px; border-top:1px solid #ccc;}
input[type="text"] { flex:1; padding:10px; border-radius:25px; border:1px solid #ccc; outline:none;}
button { border:none; border-radius:50%; font-size:18px; cursor:pointer; margin-left:6px; width:45px; height:45px; display:flex; align-items:center; justify-content:center; color:white;}
button.media { background:#25D366;}
button.send { background:#34B7F1;}
button.voice { background:#075E54;}
button.voice.recording { background:red;}
#mediaInput { display:none;}
.message img.media, .message video { max-width:200px; border-radius:8px; margin-top:6px;}
.message audio { width:200px; margin-top:6px;}
button.voice span.timer { position:absolute; bottom:-20px; font-size:12px; color:#000;}

/* Scrollbar */
.chat-box::-webkit-scrollbar { width:6px;}
.chat-box::-webkit-scrollbar-thumb { background:#888; border-radius:3px;}
.chat-box::-webkit-scrollbar-track { background:#f1f1f1;}
</style>
</head>
<body>

<header>
  <button id="backBtn">‚Üê</button>
  <h3><img id="groupPic" src=""><span id="groupName">Chat Room</span></h3>
</header>

<div class="chat-box" id="chatBox"></div>

<footer>
  <button class="media" onclick="document.getElementById('mediaInput').click()">üìé</button>
  <input type="file" id="mediaInput" accept="image/*,video/*,audio/*">
  <input type="text" id="messageInput" placeholder="Type message...">
  <button class="voice" id="voiceBtn">üé§<span class="timer"></span></button>
  <button class="send" id="sendBtn">‚û§</button>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, doc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB0UlT0KzzDfBchubvm5noKk7k4UlH52VM",
  authDomain: "nice-chat-aaee5.firebaseapp.com",
  projectId: "nice-chat-aaee5",
  storageBucket: "nice-chat-aaee5.appspot.com",
  messagingSenderId: "717368271513",
  appId: "1:717368271513:web:47452e93114b7c502dce08"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Elements
const chatBox = document.getElementById('chatBox');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const mediaInput = document.getElementById('mediaInput');
const voiceBtn = document.getElementById('voiceBtn');
const voiceTimer = voiceBtn.querySelector('.timer');
const backBtn = document.getElementById('backBtn');

let currentUser = JSON.parse(localStorage.getItem('userProfile'));
let currentGroup = JSON.parse(localStorage.getItem('currentGroup'));
if(!currentUser || !currentGroup){ alert("No group selected"); window.location.href='groups.html'; }

document.getElementById('groupName').textContent = currentGroup.name;
document.getElementById('groupPic').src = currentGroup.groupPic || 'https://via.placeholder.com/35';

const messagesRef = collection(db, "groups", currentGroup.code, "messages");
const renderedMessages = new Set();

// Format time
function formatTime(ts){
  if(!ts) return '';
  const d = ts.toDate ? ts.toDate() : new Date(ts.seconds*1000);
  return `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
}

// Play notification sound
function playSound(url){
  const audio = new Audio(url);
  audio.play().catch(()=>{});
}

// Listen from SW
navigator.serviceWorker?.addEventListener('message', event=>{
  if(event.data?.action==='playSound' && event.data?.url) playSound(event.data.url);
});

// Render message
function renderMessage(msg){
  if(!msg.id) return;
  const msgDiv = document.createElement('div');
  msgDiv.className = 'message ' + (msg.phone===currentUser.phone ? 'self':'other');
  msgDiv.innerHTML = `<img class="profile" src="${msg.profilePic||'https://via.placeholder.com/25'}">`;

  let content = `<b>${msg.username}</b><br>`;
  if(msg.text) content += msg.text+'<br>';
  if(msg.media){
    if(msg.mediaType.startsWith('image/')) content += `<img class="media" src="${msg.media}">`;
    else if(msg.mediaType.startsWith('video/')) content += `<video class="media" src="${msg.media}" muted autoplay loop playsinline></video>`;
    else if(msg.mediaType.startsWith('audio/')) content += `<audio controls src="${msg.media}"></audio>`;
  }
  content += `<div class="time">${formatTime(msg.timestamp)}</div>`;
  msgDiv.innerHTML += content;

  const delBtn = document.createElement('button');
  delBtn.className = 'delete-btn '+(msg.phone===currentUser.phone?'delete-everyone':'delete-me');
  delBtn.textContent = msg.phone===currentUser.phone?'DELETE FOR EVERYONE':'DELETE FOR ME';
  delBtn.onclick = async e=>{
    e.stopPropagation();
    if(msg.phone===currentUser.phone){
      if(!confirm("Delete this message for everyone?")) return;
      if(msg.id) await deleteDoc(doc(db,"groups",currentGroup.code,"messages",msg.id));
    }
    msgDiv.remove();
  };
  msgDiv.appendChild(delBtn);

  chatBox.appendChild(msgDiv);
  chatBox.scrollTop = chatBox.scrollHeight;

  if(msg.phone!==currentUser.phone) playSound('https://actions.google.com/sounds/v1/alarms/medium_bell_ring.ogg');
}

// Load old messages
async function loadMessages(){
  chatBox.innerHTML = "";
  const snapshot = await getDocs(messagesRef);
  let msgs = [];
  snapshot.forEach(docSnap=>{
    const msg = docSnap.data();
    msg.id = docSnap.id;
    msgs.push(msg);
  });
  msgs.sort((a,b)=> a.timestamp?.seconds - b.timestamp?.seconds);
  msgs.forEach(msg=>{
    if(!renderedMessages.has(msg.id)){
      renderedMessages.add(msg.id);
      renderMessage(msg);
    }
  });
}
loadMessages();

// Real-time listener
onSnapshot(messagesRef, snapshot=>{
  let newMsgs = [];
  snapshot.docChanges().forEach(change=>{
    if(change.type==="added"){
      const msg = change.doc.data();
      msg.id = change.doc.id;
      if(!renderedMessages.has(msg.id)){
        renderedMessages.add(msg.id);
        newMsgs.push(msg);
      }
    }
  });
  newMsgs.sort((a,b)=> a.timestamp?.seconds - b.timestamp?.seconds);
  newMsgs.forEach(msg=>renderMessage(msg));
});

// Send text
sendBtn.onclick = async ()=>{
  const text = messageInput.value.trim();
  if(!text) return;
  await addDoc(messagesRef,{
    username: currentUser.username,
    phone: currentUser.phone,
    profilePic: currentUser.profilePic,
    text,
    timestamp: serverTimestamp()
  });
  messageInput.value='';
};

// Send media
mediaInput.onchange = async e=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = async ()=>{
    await addDoc(messagesRef,{
      username: currentUser.username,
      phone: currentUser.phone,
      profilePic: currentUser.profilePic,
      media: reader.result,
      mediaType: file.type,
      timestamp: serverTimestamp()
    });
  };
  reader.readAsDataURL(file);
};

// Voice recording
let mediaRecorder, chunks=[], timerInterval, seconds=0;
let micStream;

async function initMic(){
  try{ micStream = await navigator.mediaDevices.getUserMedia({audio:true}); } 
  catch(e){ alert("Microphone not available or blocked."); }
}
initMic();

voiceBtn.onclick = ()=>{
  if(!micStream){ alert("Mic not available"); return; }
  if(voiceBtn.classList.contains('recording')){
    mediaRecorder.stop();
    voiceBtn.classList.remove('recording');
    clearInterval(timerInterval);
    voiceTimer.textContent='';
  } else {
    mediaRecorder = new MediaRecorder(micStream);
    mediaRecorder.ondataavailable = e=>chunks.push(e.data);
    mediaRecorder.onstop = ()=>{
      const blob = new Blob(chunks,{type:'audio/webm'});
      chunks=[];
      const reader = new FileReader();
      reader.onloadend = async ()=>{
        await addDoc(messagesRef,{
          username:currentUser.username,
          phone:currentUser.phone,
          profilePic:currentUser.profilePic,
          media:reader.result,
          mediaType:'audio/webm',
          timestamp:serverTimestamp()
        });
      };
      reader.readAsDataURL(blob);
    };
    mediaRecorder.start();
    voiceBtn.classList.add('recording');
    seconds=0;
    voiceTimer.textContent='0:00';
    timerInterval = setInterval(()=>{
      seconds++;
      const min=Math.floor(seconds/60), sec=seconds%60;
      voiceTimer.textContent=`${min}:${sec.toString().padStart(2,'0')}`;
    },1000);
  }
};

// Back button
backBtn.onclick = ()=> window.location.href='groups.html';

// --- PWA Service Worker Registration ---
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('firebase-messaging-sw.js')
    .then(reg=>console.log('SW registered:',reg.scope))
    .catch(err=>console.error('SW registration failed:', err));
}
</script>

</body>
</html>