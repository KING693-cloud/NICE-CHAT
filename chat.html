<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NICE Chat</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#34B7F1">
<link rel="icon" href="images/images-1.jpeg" type="image/jpeg">
<style>
body, html {margin:0;padding:0;height:100%;background:#ECE5DD;font-family:Arial,sans-serif;display:flex;flex-direction:column;}
header {background:#075E54;color:white;padding:10px;display:flex;align-items:center;gap:10px;}
header button {background:none;border:none;color:white;font-size:22px;cursor:pointer;}
header h3 {display:flex;align-items:center;gap:10px;}
header img {width:35px;height:35px;border-radius:50%;object-fit:cover;border:2px solid #25D366;}
.chat-box {flex:1;overflow-y:auto;padding:10px;display:flex;flex-direction:column;}
.message {max-width:75%;padding:10px;margin:8px 0;border-radius:10px;word-wrap:break-word;display:flex;flex-direction:column;white-space:pre-wrap;}
.message.self {background:#DCF8C6;align-self:flex-end;}
.message.other {background:#fff;align-self:flex-start;}
.message img.profile {width:25px;height:25px;border-radius:50%;border:1px solid #ccc;margin-bottom:4px;}
.message .delete-btn {margin-top:6px;font-weight:bold;font-size:13px;cursor:pointer;padding:4px 8px;border-radius:6px;text-align:center;width:fit-content;}
.message .delete-everyone {background:#d9534f;color:white;border:none;}
.message .delete-me {background:#999;color:white;border:none;}
footer {background:#fff;display:flex;align-items:center;padding:10px;border-top:1px solid #ccc;}
input[type="text"] {flex:1;padding:10px;border-radius:25px;border:1px solid #ccc;outline:none;}
button {border:none;border-radius:50%;font-size:18px;cursor:pointer;margin-left:6px;width:45px;height:45px;display:flex;align-items:center;justify-content:center;color:white;}
button.media {background:#25D366;}
button.send {background:#34B7F1;}
button.voice {background:#075E54;}
button.voice.recording {background:red;}
#mediaInput {display:none;}
.message img.media {max-width:200px;border-radius:8px;margin-top:6px;}
.message video {width:200px;max-height:180px;border-radius:10px;margin-top:6px;object-fit:cover;cursor:pointer;}
.message audio {width:200px;margin-top:6px;}
button.voice span.timer {position:absolute;bottom:-20px;font-size:12px;color:#000;}
</style>
</head>
<body>

<header>
  <button id="backBtn">‚Üê</button>
  <h3><img id="groupPic" src=""><span id="groupName">Chat Room</span></h3>
</header>

<div class="chat-box" id="chatBox"></div>

<footer>
  <button class="media" onclick="document.getElementById('mediaInput').click()">üìé</button>
  <input type="file" id="mediaInput" accept="image/*,video/*,audio/*">
  <input type="text" id="messageInput" placeholder="Type message...">
  <button class="voice" id="voiceBtn">üé§<span class="timer"></span></button>
  <button class="send" id="sendBtn">‚û§</button>
</footer>

<script type="module">
// ===== Firebase imports =====
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, doc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-messaging.js";

// ===== Firebase App =====
const firebaseConfig = {
  apiKey: "AIzaSyB0UlT0KzzDfBchubvm5noKk7k4UlH52VM",
  authDomain: "nice-chat-aaee5.firebaseapp.com",
  projectId: "nice-chat-aaee5",
  storageBucket: "nice-chat-aaee5.appspot.com",
  messagingSenderId: "717368271513",
  appId: "1:717368271513:web:47452e93114b7c502dce08"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const messaging = getMessaging(app);

// ===== DOM Elements =====
const chatBox = document.getElementById('chatBox');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const mediaInput = document.getElementById('mediaInput');
const voiceBtn = document.getElementById('voiceBtn');
const voiceTimer = voiceBtn.querySelector('.timer');
const backBtn = document.getElementById('backBtn');

// ===== Sounds =====
const outgoingSound = new Audio('OF.mp3');
const incomingSound = new Audio('OF.mp3');
outgoingSound.preload = 'auto';
incomingSound.preload = 'auto';

let userInteracted = false;
// enable sounds only after first tap/click
document.body.addEventListener('click', ()=>{ userInteracted = true; }, {once:true});
document.body.addEventListener('touchstart', ()=>{ userInteracted = true; }, {once:true});

function playOutgoing(){ if(userInteracted) outgoingSound.play().catch(()=>{}); }
function playIncoming(){ if(userInteracted) incomingSound.play().catch(()=>{}); }

// ===== Current user/group =====
let currentUser = JSON.parse(localStorage.getItem('userProfile'));
let currentGroup = JSON.parse(localStorage.getItem('currentGroup'));
if(!currentGroup || !currentUser){ alert("No group selected or user not found"); window.location.href='groups.html'; }
document.getElementById('groupName').textContent = currentGroup.name;
document.getElementById('groupPic').src = currentGroup.groupPic || 'https://via.placeholder.com/35';

// ===== Messages =====
const messagesRef = collection(db, "groups", currentGroup.code, "messages");
const renderedMessages = new Set();

function renderMessage(msg){
  if(!msg.id) return;
  const msgDiv = document.createElement('div');
  msgDiv.className = 'message ' + (msg.phone===currentUser.phone ? 'self':'other');
  msgDiv.innerHTML = `<img class="profile" src="${msg.profilePic||'https://via.placeholder.com/25'}">`;

  let content = `<b>${msg.username}</b><br>`;
  if(msg.text) content += msg.text+'<br>';
  if(msg.media){
    if(msg.mediaType.startsWith('image/')) content += `<img class="media" src="${msg.media}">`;
    else if(msg.mediaType.startsWith('video/')) content += `<video class="media" src="${msg.media}" muted autoplay loop playsinline></video>`;
    else if(msg.mediaType.startsWith('audio/')) content += `<audio controls src="${msg.media}"></audio>`;
  }
  msgDiv.innerHTML += content;

  const delBtn = document.createElement('button');
  delBtn.className = 'delete-btn '+(msg.phone===currentUser.phone?'delete-everyone':'delete-me');
  delBtn.textContent = msg.phone===currentUser.phone?'DELETE FOR EVERYONE':'DELETE FOR ME';
  delBtn.onclick = async e=>{
    e.stopPropagation();
    if(msg.phone===currentUser.phone){
      if(!confirm("Delete this message for everyone?")) return;
      if(msg.id) await deleteDoc(doc(db,"groups",currentGroup.code,"messages",msg.id));
    }
    msgDiv.remove();
  };
  msgDiv.appendChild(delBtn);

  chatBox.appendChild(msgDiv);
  chatBox.scrollTop = chatBox.scrollHeight;
}

// ===== Load messages =====
async function loadMessages(){
  chatBox.innerHTML="";
  const snapshot = await getDocs(messagesRef);
  let msgs = [];
  snapshot.forEach(docSnap=>{
    const msg = docSnap.data();
    msg.id = docSnap.id;
    msgs.push(msg);
  });
  msgs.sort((a,b)=> a.timestamp?.seconds - b.timestamp?.seconds);
  msgs.forEach(msg=>{
    if(!renderedMessages.has(msg.id)){
      renderedMessages.add(msg.id);
      renderMessage(msg);
    }
  });
  chatBox.scrollTop = chatBox.scrollHeight;
}
loadMessages();

// ===== Real-time messages =====
onSnapshot(messagesRef, snapshot=>{
  snapshot.docChanges().forEach(change=>{
    if(change.type==="added"){
      const msg = change.doc.data();
      msg.id = change.doc.id;
      if(!renderedMessages.has(msg.id)){
        renderedMessages.add(msg.id);
        renderMessage(msg);
        if(msg.phone===currentUser.phone) playOutgoing();
        else playIncoming();
      }
    }
  });
});

// ===== Send text =====
sendBtn.onclick = async ()=>{
  const text = messageInput.value.trim();
  if(!text) return;
  const msgData = { username: currentUser.username, phone: currentUser.phone, profilePic: currentUser.profilePic, text, timestamp: serverTimestamp() };
  messageInput.value='';
  await addDoc(messagesRef,msgData);
};

// ===== Send media =====
mediaInput.onchange = async e=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = async ()=>{
    const msgData = { username: currentUser.username, phone: currentUser.phone, profilePic: currentUser.profilePic, media: reader.result, mediaType: file.type, timestamp: serverTimestamp() };
    await addDoc(messagesRef,msgData);
  };
  reader.readAsDataURL(file);
};

// ===== Voice Recording =====
let mediaRecorder, chunks=[], timerInterval, seconds=0;
let micStream;
async function initMic(){
  if(localStorage.getItem('micPermissionGranted')){
    try { micStream = await navigator.mediaDevices.getUserMedia({audio:true}); } catch(e){ console.warn(e); }
    return;
  }
  try{
    micStream = await navigator.mediaDevices.getUserMedia({audio:true});
    localStorage.setItem('micPermissionGranted','true');
  } catch(e){ console.warn(e); }
}
initMic();

voiceBtn.onclick = ()=>{
  if(!micStream){ alert("Mic not available"); return; }
  if(voiceBtn.classList.contains('recording')){
    mediaRecorder.stop();
    voiceBtn.classList.remove('recording');
    clearInterval(timerInterval);
    voiceTimer.textContent='';
  } else {
    mediaRecorder = new MediaRecorder(micStream);
    mediaRecorder.ondataavailable = e=>chunks.push(e.data);
    mediaRecorder.onstop = ()=>{
      const blob = new Blob(chunks,{type:'audio/webm'});
      chunks=[];
      const reader = new FileReader();
      reader.onloadend = async ()=>{
        const msgData={ username:currentUser.username, phone:currentUser.phone, profilePic:currentUser.profilePic, media:reader.result, mediaType:'audio/webm', timestamp:serverTimestamp() };
        await addDoc(messagesRef,msgData);
      };
      reader.readAsDataURL(blob);
    };
    mediaRecorder.start();
    voiceBtn.classList.add('recording');
    seconds=0;
    voiceTimer.textContent='0:00';
    timerInterval = setInterval(()=>{
      seconds++;
      const min=Math.floor(seconds/60), sec=seconds%60;
      voiceTimer.textContent=`${min}:${sec.toString().padStart(2,'0')}`;
    },1000);
  }
};

// ===== Back button =====
backBtn.onclick = ()=>window.location.href='groups.html';

// ===== FCM Notifications =====
Notification.requestPermission().then(permission=>{
  if(permission==="granted"){
    getToken(messaging,{vapidKey:'BJo1T33ONwDqZ1K5ZWigKznRtjIydjxfYwFd5-wq4-VuCAxYKg95jQgy68vymEnlpOg6he1bKzzuVlME_KL9HkE'})
    .then(token=>console.log('FCM Token:',token)).catch(err=>console.error(err));
  }
});

onMessage(messaging, payload=>{
  if(Notification.permission==="granted"){
    new Notification(payload.notification?.title||"New message", { body: payload.notification?.body||"You received a new message", icon:'/icon.png', silent:false });
    playIncoming();
  }
});

// ===== PWA Service Worker =====
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('firebase-messaging-sw.js')
    .then(reg=>console.log('SW registered:',reg.scope))
    .catch(err=>console.error('SW registration failed:', err));
}
</script>
</body>
</html>
